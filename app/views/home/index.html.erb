<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/trunk/richmarker/src/richmarker-compiled.js' type='text/javascript'></script>
  <div class="col-md-12 pull-left-margin">
    <div class="col-md-8 pull-left-margin">
      <div style='width: 800px;'>
		  <div id="map" style='width: 800px; height: 500px;'>
		  	<%#= Gmaps({"polygons"=>{ "data" => @polygon, "options" => { "fillColor" => "#000" }}}) %>
		  </div>
		</div>
    </div>
    <div class="col-md-4" style="min-height: 500px; border: 1px solid">
      <p>Tweet</p>
      <div id="tweets">
        <%= render partial: '/property_infos/property_info', collection: @property_infos %>
      </div>
    </div>
  </div>
  <div class="clear"></div>

  <div class="rowt">
    <div class="col-md-12">

      <%= form_tag property_infos_path, method: :post, remote: true do %>
        <%= select_tag :name, options_for_select([['Price', 'price'], ['Dispute', 'dispute'], ['Infra', 'infra'], ['Nature', 'nature']]),  class: "info_name"%>

          <%= text_field_tag 'price_value[new_price]', nil, :placeholder => 'new price', class: "info_name_price_options", id: "new_price" %>
          <%= text_field_tag 'price_value[price_change_reason]', nil, :placeholder => 'Reason' , class: "info_name_price_options", id: "price_change_reason" %>

          <%= select_tag 'infra_value[new_infra]', options_for_select(['school', 'hospital', 'highway', 'tech_park']), class: "info_name_infra_options", style: "display: none", id: "new_infra"  %>
          <%= text_field_tag 'infra_value[new_date]', nil, :placeholder => 'By When', class: "info_name_infra_options", style: "display: none", id: "new_date" %>

          <%= text_area_tag :comments, nil, :placeholder => 'Tweet !!!', id: "tweet" %>
          <%= submit_tag :submit, id: "submit" %>
      <%end%>
    </div>
  </div>

<script type="text/javascript">
  //buildMap([{"lat":12.93622319969078,"lng":77.60541558265686, "infowindow": 'Hello' }])
</script>
<script type="text/javascript">
/*  var handler = Gmaps.build('Google');
     handler.buildMap({ internal: {id: 'map'}}, function(){
     var polygons = handler.addPolygons(<%= @polygon.to_json.html_safe %>,
        {
        "strokeColor": "#E9E5DC",
        "strokeOpacity": 1,
				"strokeWeight": 2,
				"fillColor": '#FF0000'
        }
     );
     handler.bounds.extendWith(polygons);
     handler.fitMapToBounds();
     handler.getMap().setZoom(18);
  });
*/
 MarkerData = [12.93533315169078, 77.60511558261397, "Elsie Roy Elementary"];
 PathData = <%= @polygon %>;
function initialize() {
     map = 
        new google.maps.Map(document.getElementById('map'));
     infowindow = new google.maps.InfoWindow();
     center = 
        new google.maps.LatLng(MarkerData[0], MarkerData[1]);
     marker = new google.maps.Marker({
        position: center,
        map: map,
        title: MarkerData[2]
    });
 
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(this.title);
        infowindow.open(map, this);
    });
 
    var path = [];
    var bounds = new google.maps.LatLngBounds();
    bounds.extend(center);
    for (var i in PathData)
    {
        var p = PathData[i];
        var latlng = new google.maps.LatLng(p[0], p[1]);
        path.push(latlng);
        bounds.extend(latlng);
    }
    var poly = new google.maps.Polygon({
        paths: path,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 3,
        fillColor: '#FF0000',
        fillOpacity: 0.1
    });
    poly.setMap(map);
     
     
    map.fitBounds(bounds);
}
 
google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script type="text/javascript">
  $('.info_name').change(function(){
    var tweet = ""; 
    if ($(this).val() == 'price') {
      $("#tweet").val('');
      $('.info_name_price_options').val('');
      $('.info_name_price_options').show();
      $('.info_name_infra_options').hide();
      $('#new_price').focus();
    } else if ($(this).val() == 'infra') {
      $("#tweet").val('');
      $('.info_name_infra_options').val('');
      $('.info_name_infra_options').show();
      $('.info_name_price_options').hide();
      $('#new_infra').focus();
      $("#new_infra, #new_date").change(function(){
        generate_tweet('infra');
      });
    }
  });

  function initialize_event_for_price(){
    $("#new_price, #price_change_reason").keyup(function(){
      generate_tweet('price');
    });
  }
  function initialize_event_for_infra(){
    $("#new_infra, #new_date").keyup(function(){
      generate_tweet('infra');
    });
  }

  function generate_tweet(info_name){
    var tweet = ""; 
    if(info_name == "price"){
      if($('#new_price').val() != "")
      tweet += "New price is " + $('#new_price').val();
      if($('#price_change_reason').val() != "")
      tweet += " because of " + $('#price_change_reason').val();
    }else if(info_name == "infra"){
      tweet += "New " + $('#new_infra').val() + " is comming around " + $('#new_date').val();
    }
    $("#tweet").val(tweet);
  }

  function push_the_tweet(tweet){
    $('div#tweets').append(tweet);
  }

  function get_feed(){
    setTimeout(function() {
      $.ajax({
        url: '<%= get_feed_property_infos_path %>',
        method: 'GET',
        success: get_feed(),
        type: 'JS'
      });
    }, 5000);
  }

  initialize_event_for_price();
  initialize_event_for_infra();
  generate_tweet($('.info_name') == "price");
  get_feed();

</script>
	
